{% extends 'base.html' %}
{% load static %}
{% block title %}Онлайн трансляция{% endblock %}
{% block content %}
    <script src="{% static 'js/hls.light.min.js' %}"></script>
    <section id="livecam_page">
        <div class="livecam_page">
            <div class="livecam_page-block">
                <p class="title_livecam">Камера на входной группе</p>
                <video id="cam_entrance_video" class="livecam_video_block-video" muted playsinline controls preload="none"></video>
            </div>
            <div class="livecam_page-block">
                <p class="title_livecam">Камера на входной группе заднего двора</p>
                <video id="cam_b_entrance_video" class="livecam_video_block-video" muted playsinline controls preload="none"></video>
            </div>
        </div>
        {% if request.user.is_superuser %}
            {#            <script src="{% static 'js/adapter.js' %}"></script>#}
            {#            <script src="{% static 'js/janus.js' %}"></script>#}
            <div class="livecam_page">
                <div class="livecam_page-block">
                    <p class="title_livecam">Камера на входной группе</p>
                    <video id="cam_entrance_video_new" class="livecam_video_block-video" muted playsinline controls preload="none"></video>
                </div>
                <div class="livecam_page-block">
                    <p class="title_livecam">Камера на входной группе заднего двора</p>
                    <video id="cam_b_entrance_video_new" class="livecam_video_block-video" muted playsinline controls preload="none"></video>
                </div>
            </div>
        {% endif %}
    </section>
    {% if request.user.is_superuser %}
        <script>
            const iceServers = [
                { urls: "stun:home.amtrend.ru:3478" },
                {
                    urls: "turn:home.amtrend.ru:3478",
                    username: "webrtcuser",
                    credential: "webrtcpass"
                }
            ];

            async function startWebRTC(videoElemId, cameraPath) {
                const video = document.getElementById(videoElemId);
                if (!video) {
                    console.error("Video element not found:", videoElemId);
                    return;
                }

                const pc = new RTCPeerConnection({ iceServers });

                pc.ontrack = event => {
                    if (video.srcObject !== event.streams[0]) {
                        video.srcObject = event.streams[0];
                        video.play().catch(e => console.warn("Play error", e));
                    }
                };

                try {
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);

                    // Ждём завершения ICE Gathering
                    await new Promise(resolve => {
                        if (pc.iceGatheringState === "complete") {
                            resolve();
                        } else {
                            const checkState = () => {
                                if (pc.iceGatheringState === "complete") {
                                    pc.removeEventListener("icegatheringstatechange", checkState);
                                    resolve();
                                }
                            };
                            pc.addEventListener("icegatheringstatechange", checkState);
                        }
                    });

                    // Формируем URL для запроса
                    const url = `${window.location.protocol}//${window.location.host}/webrtc/${cameraPath}/whep`;

                    // Отправляем SDP на сервер
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/sdp",
                            "Accept": "application/sdp",
                        },
                        body: pc.localDescription.sdp
                    });

                    if (!response.ok) {
                        const text = await response.text();
                        throw new Error(`WHEP server error: ${response.status} - ${text}`);
                    }

                    const answerSdp = await response.text();
                    const answerDesc = new RTCSessionDescription({ type: "answer", sdp: answerSdp });
                    await pc.setRemoteDescription(answerDesc);

                } catch (err) {
                    console.error(`WebRTC error for ${cameraPath}:`, err);
                }
            }

            // Запуск всех камер
            startWebRTC("cam_entrance_video_new", "cam_entrance");
            startWebRTC("cam_b_entrance_video_new", "cam_back_entrance");
        </script>



        {#        <script>#}
        {#            Janus.init({#}
        {#                debug: "all",#}
        {#                callback: function() {#}
        {#                    const protocol = (window.location.protocol === "https:") ? "wss" : "ws";#}
        {#                    const hostname = window.location.hostname;#}
        {#                    const port = window.location.port ? `:${window.location.port}` : '';#}
        {#                    const janusWsUrl = `${protocol}://${hostname}${port}/janus`; // ws://localhost:8188/#}
        {#                    var janus = new Janus({#}
        {#                        server: janusWsUrl,#}
        {#                        success: function() {#}
        {#                            // Connect to camera with id#}
        {#                            function attachToStream(id, videoElementId) {#}
        {#                                janus.attach({#}
        {#                                    plugin: "janus.plugin.streaming",#}
        {#                                    success: function(pluginHandle) {#}
        {#                                        pluginHandle.send({ message: { request: "watch", id: id } });#}
        {##}
        {#                                        // When get msg from janus#}
        {#                                        pluginHandle.onmessage = function(msg, jsep) {#}
        {#                                            if(jsep) {#}
        {#                                                pluginHandle.createAnswer({#}
        {#                                                    jsep: jsep,#}
        {#                                                    media: { audioSend: false, videoSend: false },#}
        {#                                                    success: function(jsepAnswer) {#}
        {#                                                        pluginHandle.send({ message: { request: "start" }, jsep: jsepAnswer });#}
        {#                                                    },#}
        {#                                                    error: function(error) {#}
        {#                                                        console.error("Error when create response:", error);#}
        {#                                                    }#}
        {#                                                });#}
        {#                                            }#}
        {#                                        };#}
        {##}
        {#                                        // When get video of track#}
        {#                                        pluginHandle.onremotetrack = function(track, mid, on) {#}
        {#                                            if(on && track.kind === "video") {#}
        {#                                                const stream = new MediaStream();#}
        {#                                                stream.addTrack(track);#}
        {#                                                const video = document.getElementById(videoElementId);#}
        {#                                                video.srcObject = stream;#}
        {#                                                //video.play();#}
        {#                                                video.addEventListener("canplay", () => {#}
        {#                                                    video.play().catch((e) => {#}
        {#                                                        console.warn("Playback error:", e);#}
        {#                                                    });#}
        {#                                                }, { once: true });#}
        {#                                            }#}
        {#                                        };#}
        {#                                    },#}
        {#                                    error: function(error) {#}
        {#                                        console.error("Error connect to plugin:", error);#}
        {#                                    }#}
        {#                                });#}
        {#                            }#}
        {##}
        {#                            // Add cameras#}
        {#                            attachToStream(1, "cam_entrance_video_new");#}
        {#                            attachToStream(2, "cam_b_entrance_video_new");#}
        {#                        }#}
        {#                    });#}
        {#                }#}
        {#            });#}
        {#        </script>#}
    {% endif %}

{% endblock %}