{% extends 'base.html' %}
{% load static %}
{% block title %}Онлайн трансляция{% endblock %}
{% block content %}
    <script src="{% static 'js/adapter.js' %}"></script>
    <script src="{% static 'js/janus.js' %}"></script>
    <section id="livecam_page">
        <div class="livecam_page">
            <div class="livecam_page-block">
                <p class="title_livecam">Камера на входной группе</p>
                <video id="cam_entrance_video" class="livecam_video_block-video" muted playsinline controls preload="none"></video>
            </div>
            <div class="livecam_page-block">
                <p class="title_livecam">Камера на входной группе заднего двора</p>
                <video id="cam_b_entrance_video" class="livecam_video_block-video" muted playsinline controls preload="none"></video>
            </div>
        </div>

        {% if request.user.is_superuser %}
            <div class="livecam_page">
                <div class="livecam_page-block">
                    <p class="title_livecam">Камера на входной группе</p>
                    <video id="cam_entrance_video_new" class="livecam_video_block-video" muted playsinline controls preload="none"></video>
                </div>
                <div class="livecam_page-block">
                    <p class="title_livecam">Камера на входной группе заднего двора</p>
                    <video id="cam_b_entrance_video_new" class="livecam_video_block-video" muted playsinline controls preload="none"></video>
                </div>
            </div>
        {% endif %}
    </section>
    <script>
        Janus.init({
            debug: "all",
            callback: function() {
                const protocol = (window.location.protocol === "https:") ? "wss" : "ws";
                const hostname = window.location.hostname;
                const port = window.location.port ? `:${window.location.port}` : '';
                const janusWsUrl = `${protocol}://${hostname}${port}/janus`; // ws://localhost:8188/
                var janus = new Janus({
                    server: janusWsUrl,
                    success: function() {
                        // Connect to camera with id
                        function attachToStream(id, videoElementId) {
                            janus.attach({
                                plugin: "janus.plugin.streaming",
                                success: function(pluginHandle) {
                                    pluginHandle.send({ message: { request: "watch", id: id } });

                                    // When get msg from janus
                                    pluginHandle.onmessage = function(msg, jsep) {
                                        if(jsep) {
                                            pluginHandle.createAnswer({
                                                jsep: jsep,
                                                media: { audioSend: false, videoSend: false },
                                                success: function(jsepAnswer) {
                                                    pluginHandle.send({ message: { request: "start" }, jsep: jsepAnswer });
                                                },
                                                error: function(error) {
                                                    console.error("Error when create response:", error);
                                                }
                                            });
                                        }
                                    };

                                    // When get video of track
                                    pluginHandle.onremotetrack = function(track, mid, on) {
                                        if(on && track.kind === "video") {
                                            const stream = new MediaStream();
                                            stream.addTrack(track);
                                            const video = document.getElementById(videoElementId);
                                            video.srcObject = stream;
                                            //video.play();
                                            video.addEventListener("canplay", () => {
                                                video.play().catch((e) => {
                                                    console.warn("Playback error:", e);
                                                });
                                            }, { once: true });
                                        }
                                    };
                                },
                                error: function(error) {
                                    console.error("Error connect to plugin:", error);
                                }
                            });
                        }

                        // Add cameras
                        attachToStream(1, "cam_entrance_video_new");
                        attachToStream(2, "cam_b_entrance_video_new");
                    }
                });
            }
        });
    </script>


{% endblock %}